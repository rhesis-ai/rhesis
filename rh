#!/bin/bash

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Function to display help
show_help() {
    echo -e "${CYAN}"
    echo "  ____  _   _ _____ ____ ___ ____  "
    echo " |  _ \| | | | ____/ ___|_ _/ ___| "
    echo " | |_) | |_| |  _| \___ \| |\___ \ "
    echo " |  _ <|  _  | |___ ___) | | ___) |"
    echo " |_| \_\_| |_|_____|____/___|____/ "
    echo -e "${NC}"
    echo ""
    echo -e "${WHITE}Rhesis CLI - Development Server Manager${NC}"
    echo -e "${PURPLE}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${NC}"
    echo ""
    echo -e "${YELLOW}Usage:${NC}"
    echo -e "  ${GREEN}./rh start${NC}           - Start all services with Docker (zero-config)"
    echo -e "  ${GREEN}./rh stop${NC}            - Stop all Docker services"
    echo -e "  ${GREEN}./rh restart${NC}         - Restart all Docker services"
    echo -e "  ${GREEN}./rh logs${NC}            - View logs from all services"
    echo -e "  ${GREEN}./rh delete${NC}          - Delete all services, images, volumes, and data"
    echo -e "  ${GREEN}./rh backend start${NC}   - Start the backend server (local)"
    echo -e "  ${GREEN}./rh frontend start${NC}  - Start the frontend server (local)"
    echo -e "  ${GREEN}./rh frontend test${NC}   - Run frontend tests"
    echo -e "  ${GREEN}./rh docs start${NC}      - Start the documentation server (local)"
    echo -e "  ${GREEN}./rh worker start${NC}    - Start the Celery worker (local)"
    echo -e "  ${GREEN}./rh help${NC}            - Show this help message"
    echo ""
    echo -e "${YELLOW}Examples:${NC}"
    echo -e "  ${BLUE}./rh start${NC}               # Start all services with Docker"
    echo -e "  ${BLUE}./rh stop${NC}                # Stop all Docker services"
    echo -e "  ${BLUE}./rh delete${NC}              # Delete everything (services, images, volumes, data)"
    echo -e "  ${BLUE}./rh logs backend${NC}        # View backend logs"
    echo -e "  ${BLUE}./rh backend start${NC}       # Start backend locally (without Docker)"
    echo -e "  ${BLUE}./rh frontend start${NC}      # Start frontend locally (without Docker)"
    echo -e "  ${BLUE}./rh frontend test${NC}       # Run frontend tests"
    echo ""
}

# Function to start all services with Docker Compose
start_all() {
    echo -e "${GREEN}üöÄ Starting all Rhesis services with Docker...${NC}"
    echo -e "${BLUE}‚ÑπÔ∏è  Using zero-configuration local setup${NC}"
    echo ""
    
    cd "$SCRIPT_DIR" || {
        echo -e "${RED}‚ùå Error: Script directory not found${NC}"
        exit 1
    }
    
    # Check if Docker is running
    if ! docker info > /dev/null 2>&1; then
        echo -e "${RED}‚ùå Error: Docker is not running${NC}"
        echo -e "${YELLOW}üí° Please start Docker Desktop and try again${NC}"
        exit 1
    fi
    
    # Check if .env.docker.local exists
    if [ ! -f ".env.docker.local" ]; then
        echo -e "${RED}‚ùå Error: .env.docker.local not found${NC}"
        exit 1
    fi
    
    echo -e "${YELLOW}üì¶ Starting services...${NC}"
    docker compose -f docker-compose.local.yml --env-file .env.docker.local up -d
    
    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}‚úÖ All services started successfully!${NC}"
        echo ""
        echo -e "${CYAN}üåê Access the platform:${NC}"
        echo -e "   Frontend:  ${WHITE}http://localhost:3000${NC} (auto-login enabled)"
        echo -e "   Backend:   ${WHITE}http://localhost:8080/docs${NC}"
        echo -e "   Worker:    ${WHITE}http://localhost:8081/health/basic${NC}"
        echo ""
        echo -e "${YELLOW}üí° Useful commands:${NC}"
        echo -e "   View logs:    ${GREEN}./rh logs${NC}"
        echo -e "   Stop all:     ${GREEN}./rh stop${NC}"
        echo -e "   Restart all:  ${GREEN}./rh restart${NC}"
        echo ""
    else
        echo -e "${RED}‚ùå Error: Failed to start services${NC}"
        exit 1
    fi
}

# Function to stop all services
stop_all() {
    echo -e "${YELLOW}üõë Stopping all Rhesis services...${NC}"
    
    cd "$SCRIPT_DIR" || {
        echo -e "${RED}‚ùå Error: Script directory not found${NC}"
        exit 1
    }
    
    docker compose -f docker-compose.local.yml down
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ All services stopped${NC}"
    else
        echo -e "${RED}‚ùå Error: Failed to stop services${NC}"
        exit 1
    fi
}

# Function to restart all services
restart_all() {
    echo -e "${YELLOW}üîÑ Restarting all Rhesis services...${NC}"
    
    cd "$SCRIPT_DIR" || {
        echo -e "${RED}‚ùå Error: Script directory not found${NC}"
        exit 1
    }
    
    docker compose -f docker-compose.local.yml --env-file .env.docker.local restart
    
    if [ $? -eq 0 ]; then
        echo -e "${GREEN}‚úÖ All services restarted${NC}"
    else
        echo -e "${RED}‚ùå Error: Failed to restart services${NC}"
        exit 1
    fi
}

# Function to view logs
view_logs() {
    echo -e "${BLUE}üìã Viewing logs...${NC}"
    
    cd "$SCRIPT_DIR" || {
        echo -e "${RED}‚ùå Error: Script directory not found${NC}"
        exit 1
    }
    
    if [ -z "$1" ]; then
        # No service specified, show all logs
        docker compose -f docker-compose.local.yml logs -f
    else
        # Show logs for specific service
        docker compose -f docker-compose.local.yml logs -f "$1"
    fi
}

# Function to delete all services, images, volumes, and data
delete_all() {
    echo -e "${RED}‚ö†Ô∏è  WARNING: This will delete ALL Docker resources for Rhesis!${NC}"
    echo -e "${YELLOW}This includes:${NC}"
    echo -e "  - All running containers"
    echo -e "  - All Docker images"
    echo -e "  - All volumes (DATABASE DATA WILL BE LOST!)"
    echo -e "  - All networks"
    echo ""
    echo -e "${RED}This action CANNOT be undone!${NC}"
    echo ""
    read -p "$(echo -e ${YELLOW}Are you sure you want to continue? Type \'yes\' to confirm: ${NC})" -r
    echo ""
    
    if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
        echo -e "${GREEN}‚úÖ Deletion cancelled${NC}"
        exit 0
    fi
    
    echo -e "${YELLOW}üóëÔ∏è  Deleting all Rhesis Docker resources...${NC}"
    
    cd "$SCRIPT_DIR" || {
        echo -e "${RED}‚ùå Error: Script directory not found${NC}"
        exit 1
    }
    
    # Stop and remove all services, volumes, and images
    docker compose -f docker-compose.local.yml down -v --rmi all
    
    if [ $? -eq 0 ]; then
        echo ""
        echo -e "${GREEN}‚úÖ All Rhesis Docker resources deleted successfully!${NC}"
        echo ""
        echo -e "${CYAN}üí° To start fresh:${NC}"
        echo -e "   ${GREEN}./rh start${NC}"
        echo ""
    else
        echo -e "${RED}‚ùå Error: Failed to delete all resources${NC}"
        exit 1
    fi
}

# Function to start backend
start_backend() {
    echo -e "${GREEN}üîß Starting Rhesis Backend...${NC}"
    cd "$SCRIPT_DIR/apps/backend" || {
        echo -e "${RED}‚ùå Error: Backend directory not found${NC}"
        exit 1
    }

    if [ -f "start.sh" ]; then
        ./start.sh
    else
        echo -e "${RED}‚ùå Error: Backend start.sh not found${NC}"
        exit 1
    fi
}

# Function to start frontend
start_frontend() {
    echo -e "${GREEN}üåê Starting Rhesis Frontend...${NC}"
    cd "$SCRIPT_DIR/apps/frontend" || {
        echo -e "${RED}‚ùå Error: Frontend directory not found${NC}"
        exit 1
    }

    if [ -f "start.sh" ]; then
        ./start.sh
    else
        echo -e "${RED}‚ùå Error: Frontend start.sh not found${NC}"
        exit 1
    fi
}

# Function to start docs
start_docs() {
    echo -e "${GREEN}üìö Starting Rhesis Documentation...${NC}"
    cd "$SCRIPT_DIR/docs/src" || {
        echo -e "${RED}‚ùå Error: Documentation directory not found${NC}"
        exit 1
    }

    if [ -f "start.sh" ]; then
        ./start.sh
    else
        echo -e "${RED}‚ùå Error: Docs start.sh not found${NC}"
        exit 1
    fi
}

# Function to start worker
start_worker() {
    echo -e "${GREEN}‚öôÔ∏è  Starting Rhesis Worker...${NC}"
    
    # Kill any existing celery workers first
    echo -e "${YELLOW}üîç Checking for existing Celery workers...${NC}"
    if pgrep -f celery > /dev/null; then
        echo -e "${YELLOW}üõë Stopping existing Celery workers...${NC}"
        pkill -9 -f celery
        sleep 1
        echo -e "${GREEN}‚úÖ Existing workers stopped${NC}"
    else
        echo -e "${BLUE}‚ÑπÔ∏è  No existing workers found${NC}"
    fi
    
    # Clear Python cache
    echo -e "${YELLOW}üßπ Clearing Python cache...${NC}"
    cd "$SCRIPT_DIR" || {
        echo -e "${RED}‚ùå Error: Script directory not found${NC}"
        exit 1
    }
    find apps/backend -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null
    find apps/backend -type f -name "*.pyc" -delete 2>/dev/null
    echo -e "${GREEN}‚úÖ Cache cleared${NC}"
    
    cd "$SCRIPT_DIR/apps/backend" || {
        echo -e "${RED}‚ùå Error: Backend directory not found${NC}"
        exit 1
    }

    LOG_FILE="$SCRIPT_DIR/celery.log"
    echo -e "${GREEN}üöÄ Starting new Celery worker...${NC}"
    echo -e "${BLUE}üìù Logs will be written to: ${LOG_FILE}${NC}"
    echo -e "${YELLOW}üí° Press Ctrl+C to stop the worker${NC}"
    echo ""
    
    # Set up trap to handle Ctrl+C gracefully
    trap "echo -e '\n${YELLOW}üõë Shutting down worker...${NC}'; exit" INT TERM
    
    # Run in foreground - using uv run handles the virtual environment automatically
    # Using --logfile parameter to write logs directly
    # Using --pool=solo to avoid forking issues on macOS with ML libraries (DeepEval/PyTorch)
    exec uv run celery -A rhesis.backend.worker worker --loglevel=DEBUG -Q celery,execution --pool=solo --logfile="$LOG_FILE"
}

# Function to run frontend tests
test_frontend() {
    echo -e "${GREEN}üß™ Running Frontend Tests...${NC}"
    cd "$SCRIPT_DIR/apps/frontend" || {
        echo -e "${RED}‚ùå Error: Frontend directory not found${NC}"
        exit 1
    }

    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo -e "${YELLOW}üì¶ Installing dependencies first...${NC}"
        npm install || {
            echo -e "${RED}‚ùå Error: Failed to install dependencies${NC}"
            exit 1
        }
    fi

    # Run tests
    echo -e "${BLUE}üß™ Executing tests...${NC}"
    npm test || {
        echo -e "${RED}‚ùå Error: Tests failed${NC}"
        exit 1
    }

    echo -e "${GREEN}‚úÖ Frontend tests completed!${NC}"
}

# Parse command line arguments
case "$1" in
    "start")
        start_all
        ;;
    "stop")
        stop_all
        ;;
    "restart")
        restart_all
        ;;
    "logs")
        view_logs "$2"
        ;;
    "delete")
        delete_all
        ;;
    "backend")
        case "$2" in
            "start")
                start_backend
                ;;
            *)
                echo -e "${RED}‚ùå Unknown backend command: $2${NC}"
                echo -e "${YELLOW}Use: ./rh backend start${NC}"
                exit 1
                ;;
        esac
        ;;
    "frontend")
        case "$2" in
            "start")
                start_frontend
                ;;
            "test")
                test_frontend
                ;;
            *)
                echo -e "${RED}‚ùå Unknown frontend command: $2${NC}"
                echo -e "${YELLOW}Use: ./rh frontend start or ./rh frontend test${NC}"
                exit 1
                ;;
        esac
        ;;
    "docs")
        case "$2" in
            "start")
                start_docs
                ;;
            *)
                echo -e "${RED}‚ùå Unknown docs command: $2${NC}"
                echo -e "${YELLOW}Use: ./rh docs start${NC}"
                exit 1
                ;;
        esac
        ;;
    "worker")
        case "$2" in
            "start")
                start_worker
                ;;
            *)
                echo -e "${RED}‚ùå Unknown worker command: $2${NC}"
                echo -e "${YELLOW}Use: ./rh worker start${NC}"
                exit 1
                ;;
        esac
        ;;
    "help"|"--help"|"-h"|"")
        show_help
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $1${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
