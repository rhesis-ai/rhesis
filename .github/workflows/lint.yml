name: Lint Check

on:
  workflow_dispatch:
  pull_request:
    branches: [ main, release/* ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for paths-filter

    - name: Check for file changes
      uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          frontend:
            - 'apps/frontend/**'
          docs:
            - 'docs/src/**'
            - 'docs/content/**'
          sdk:
            - 'sdk/**'
          backend:
            - 'apps/backend/**'
          penelope:
            - 'penelope/**'

    # Python-based linting (SDK, Backend, Penelope)
    - name: Set up Python
      if: steps.filter.outputs.sdk == 'true' || steps.filter.outputs.backend == 'true' || steps.filter.outputs.penelope == 'true' || github.event_name == 'workflow_dispatch'
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install uv
      if: steps.filter.outputs.sdk == 'true' || steps.filter.outputs.backend == 'true' || steps.filter.outputs.penelope == 'true' || github.event_name == 'workflow_dispatch'
      uses: astral-sh/setup-uv@v6
      with:
        version: latest
        enable-cache: true

    # - name: Check SDK uv.lock file
    #   if: steps.filter.outputs.sdk == 'true' ||  github.event_name == 'workflow_dispatch'
    #   run: |
    #     cd sdk
    #     uv lock --check

    - name: Run SDK linting
      if: steps.filter.outputs.sdk == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        cd sdk
        make lint
      continue-on-error: false

    # - name: Check Backend uv.lock file
    #   if: steps.filter.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
    #   run: |
    #     cd apps/backend
    #     uv lock --check

    - name: Run Backend linting
      if: steps.filter.outputs.backend == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        cd apps/backend
        make lint
      continue-on-error: false

    - name: Run Penelope linting
      if: steps.filter.outputs.penelope == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        cd penelope
        make lint
      continue-on-error: false

    # Frontend & Docs Linting (both use Node.js)
    - name: Set up Node.js for Frontend/Docs
      if: steps.filter.outputs.frontend == 'true' || steps.filter.outputs.docs == 'true' || github.event_name == 'workflow_dispatch'
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install frontend dependencies
      if: steps.filter.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        cd apps/frontend
        npm ci --legacy-peer-deps

    - name: Run frontend validation (format, lint, type-check, build)
      if: steps.filter.outputs.frontend == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        cd apps/frontend
        ./scripts/validate.sh
      continue-on-error: false
      env:
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET || 'dummy-secret-for-ci-build' }}
        NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL || 'http://localhost:3000' }}
        NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL || 'http://localhost:8080' }}
        NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL || 'http://localhost:8080' }}
        BACKEND_URL: ${{ secrets.BACKEND_URL || 'http://localhost:8080' }}
        FRONTEND_ENV: 'production'
        APP_VERSION: '0.2.4'
        NEXT_PUBLIC_AUTH0_CLIENT_ID: ${{ secrets.NEXT_PUBLIC_AUTH0_CLIENT_ID || 'dummy-client-id' }}
        NEXT_PUBLIC_AUTH0_DOMAIN: ${{ secrets.NEXT_PUBLIC_AUTH0_DOMAIN || 'dummy-domain.auth0.com' }}

    # Documentation Linting
    - name: Install docs dependencies
      if: steps.filter.outputs.docs == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        cd docs/src
        npm ci

    - name: Run docs linting
      if: steps.filter.outputs.docs == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        cd docs/src
        npm run lint
      continue-on-error: false

    - name: Run docs prettier check
      if: steps.filter.outputs.docs == 'true' || github.event_name == 'workflow_dispatch'
      run: |
        cd docs/src
        npm run format:check
      continue-on-error: false

    # Summary
    - name: Lint Summary
      if: always()
      run: |
        {
          echo "## Lint Check Results ✅"
          echo ""
          echo "- **Branch**: ${{ github.ref_name }}"
          echo ""
          echo "### What was checked:"
        } >> "$GITHUB_STEP_SUMMARY"

        if [ "${{ steps.filter.outputs.sdk }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "- **SDK**: Code formatting and linting with ruff ✅" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- **SDK**: Skipped (no changes detected)" >> "$GITHUB_STEP_SUMMARY"
        fi

        # if [ "${{ steps.filter.outputs.backend }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
        #   echo "- **Backend**: Code formatting and linting with ruff ✅" >> "$GITHUB_STEP_SUMMARY"
        # else
        #   echo "- **Backend**: Skipped (no changes detected)" >> "$GITHUB_STEP_SUMMARY"
        # fi

        if [ "${{ steps.filter.outputs.penelope }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "- **Penelope**: Code formatting and linting with ruff ✅" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- **Penelope**: Skipped (no changes detected)" >> "$GITHUB_STEP_SUMMARY"
        fi

        if [ "${{ steps.filter.outputs.frontend }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "- **Frontend**: ESLint, Prettier formatting, TypeScript type checking, and build validation ✅" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- **Frontend**: Skipped (no changes detected)" >> "$GITHUB_STEP_SUMMARY"
        fi

        if [ "${{ steps.filter.outputs.docs }}" == "true" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          echo "- **Docs**: ESLint and Prettier formatting ✅" >> "$GITHUB_STEP_SUMMARY"
        else
          echo "- **Docs**: Skipped (no changes detected)" >> "$GITHUB_STEP_SUMMARY"
        fi
