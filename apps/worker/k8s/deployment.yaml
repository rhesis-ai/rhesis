apiVersion: apps/v1
kind: Deployment
metadata:
  name: rhesis-worker
  namespace: rhesis-worker-dev
  labels:
    app: rhesis-worker
    component: worker
spec:
  replicas: 4
  selector:
    matchLabels:
      app: rhesis-worker
  template:
    metadata:
      labels:
        app: rhesis-worker
        component: worker
      annotations:
        # Always restart pods on every deployment
        deployment-timestamp: "placeholder"
    spec:
      serviceAccountName: rhesis-worker-sa
      containers:
      - name: worker
        image: gcr.io/PROJECT_ID/rhesis-worker:latest
        imagePullPolicy: Always
        resources:
          requests:
            memory: "4Gi"
            cpu: "250m"
          limits:
            memory: "6Gi"
            cpu: "1000m"
        env:
        - name: BROKER_URL
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: BROKER_URL
        - name: CELERY_RESULT_BACKEND
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: CELERY_RESULT_BACKEND
        - name: SQLALCHEMY_DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SQLALCHEMY_DATABASE_URL
        - name: SQLALCHEMY_DB_MODE
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SQLALCHEMY_DB_MODE
        - name: SQLALCHEMY_DB_DRIVER
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SQLALCHEMY_DB_DRIVER
        - name: SQLALCHEMY_DB_USER
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SQLALCHEMY_DB_USER
        - name: SQLALCHEMY_DB_PASS
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SQLALCHEMY_DB_PASS
        - name: SQLALCHEMY_DB_HOST
          value: "127.0.0.1"
        - name: SQLALCHEMY_DB_PORT
          value: "5432"
        - name: USE_TCP_DATABASE
          value: "true"
        - name: SQLALCHEMY_DB_NAME
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SQLALCHEMY_DB_NAME
        - name: LOG_LEVEL
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: LOG_LEVEL
        - name: CELERY_WORKER_LOGLEVEL
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: CELERY_WORKER_LOGLEVEL
        - name: CELERY_WORKER_CONCURRENCY
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: CELERY_WORKER_CONCURRENCY
        - name: GEMINI_API_KEY
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: GEMINI_API_KEY
        - name: GOOGLE_API_KEY
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: GOOGLE_API_KEY
        - name: GEMINI_MODEL_NAME
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: GEMINI_MODEL_NAME
        - name: DEFAULT_GENERATION_MODEL
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: DEFAULT_GENERATION_MODEL
        - name: DEFAULT_MODEL_NAME
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: DEFAULT_MODEL_NAME
        - name: GOOGLE_APPLICATION_CREDENTIALS
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: GOOGLE_APPLICATION_CREDENTIALS
        - name: VERTEX_AI_LOCATION
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: VERTEX_AI_LOCATION
        - name: VERTEX_AI_PROJECT
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: VERTEX_AI_PROJECT
        - name: AZURE_OPENAI_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: AZURE_OPENAI_ENDPOINT
        - name: AZURE_OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: AZURE_OPENAI_API_KEY
        - name: AZURE_OPENAI_DEPLOYMENT_NAME
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: AZURE_OPENAI_DEPLOYMENT_NAME
        - name: AZURE_OPENAI_API_VERSION
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: AZURE_OPENAI_API_VERSION
        - name: PERSPECTIVE_API_KEY
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: PERSPECTIVE_API_KEY
        # SMTP configuration for email notifications
        - name: SMTP_HOST
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SMTP_HOST
        - name: SMTP_PORT
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SMTP_PORT
        - name: SMTP_USER
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SMTP_USER
        - name: SMTP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: SMTP_PASSWORD
        - name: FRONTEND_URL
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: FRONTEND_URL
        - name: DB_ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: DB_ENCRYPTION_KEY
        # Memory optimization settings
        - name: PYTHONMALLOC
          value: "malloc"
        - name: MALLOC_TRIM_THRESHOLD_
          value: "100000"
        - name: MALLOC_MMAP_THRESHOLD_
          value: "131072"
        - name: CELERY_WORKER_HIJACK_ROOT_LOGGER
          value: "False"
        - name: CELERY_WORKER_LOG_COLOR
          value: "False"
        - name: WORKER_ENV
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: worker_env
              optional: true
        # Storage service configuration
        - name: STORAGE_SERVICE_URI
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: STORAGE_SERVICE_URI
        - name: STORAGE_SERVICE_ACCOUNT_KEY
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: STORAGE_SERVICE_ACCOUNT_KEY
        - name: LOCAL_STORAGE_PATH
          valueFrom:
            secretKeyRef:
              name: rhesis-worker-secrets
              key: LOCAL_STORAGE_PATH
        ports:
        - containerPort: 8080
          name: health
        livenessProbe:
          httpGet:
            path: /ping
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 180
          periodSeconds: 60
          timeoutSeconds: 30
          failureThreshold: 10
          successThreshold: 1
        readinessProbe:
          httpGet:
            path: /health/basic
            port: 8080
            scheme: HTTP
          initialDelaySeconds: 120
          periodSeconds: 30
          timeoutSeconds: 30
          failureThreshold: 10
          successThreshold: 1
      
      # Cloud SQL Auth Proxy sidecar
      - name: cloudsql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:2.8.0
        args:
          - "--structured-logs"
          - "--port=5432"
          - "PROJECT_ID:REGION:CLOUDSQL_INSTANCE"
        securityContext:
          runAsNonRoot: true
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      restartPolicy: Always 