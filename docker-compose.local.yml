# Docker Compose configuration for LOCAL DEVELOPMENT ONLY
# 
# ‚ö†Ô∏è WARNING: This configuration is for LOCAL DEVELOPMENT ONLY!
# 
# This file provides a simplified setup for local development by:
# - Using environment variables from .env.docker.local
# - Enabling local authentication bypass
# - Creating a default admin user (admin@local.dev)
# - Auto-login to dashboard
#
# üìã QUICK START:
# 1. Copy the example file: cp .env.example.docker .env.docker.local
# 2. (Optional) Update RHESIS_API_KEY in .env.docker.local
# 3. Start services: docker compose -f docker-compose.local.yml --env-file .env.docker.local up
# 4. Visit: http://localhost:3000 (you'll be auto-logged in)
#
# üîë DEFAULT CREDENTIALS:
#   Email: admin@local.dev (created automatically)
#   Password: Not needed (auto-login enabled)
#
# For production deployment, see: .env.example and docs/content/getting-started/self-hosting.mdx

# Define configurations using YAML anchors with environment variables
x-common-database: &common-database
  SQLALCHEMY_DATABASE_URL: ${SQLALCHEMY_DATABASE_URL}
  SQLALCHEMY_DB_DRIVER: ${SQLALCHEMY_DB_DRIVER:-postgresql}
  SQLALCHEMY_DB_PORT: ${SQLALCHEMY_DB_PORT:-5432}
  SQLALCHEMY_DB_USER: ${SQLALCHEMY_DB_USER}
  SQLALCHEMY_DB_PASS: ${SQLALCHEMY_DB_PASS}
  SQLALCHEMY_DB_HOST: ${SQLALCHEMY_DB_HOST:-postgres}
  SQLALCHEMY_DB_NAME: ${SQLALCHEMY_DB_NAME}
  DB_ENCRYPTION_KEY: ${DB_ENCRYPTION_KEY}

x-common-redis: &common-redis
  REDIS_URL: ${REDIS_URL}
  BROKER_URL: ${BROKER_URL}
  CELERY_RESULT_BACKEND: ${CELERY_RESULT_BACKEND}

x-common-auth0: &common-auth0
  AUTH0_DOMAIN: ${AUTH0_DOMAIN}
  AUTH0_AUDIENCE: ${AUTH0_AUDIENCE}
  AUTH0_CLIENT_ID: ${AUTH0_CLIENT_ID}
  AUTH0_CLIENT_SECRET: ${AUTH0_CLIENT_SECRET}
  AUTH0_SECRET_KEY: ${AUTH0_SECRET_KEY}

x-common-smtp: &common-smtp
  SMTP_HOST: ${SMTP_HOST:-smtp.example.com}
  SMTP_PORT: ${SMTP_PORT:-587}
  SMTP_USER: ${SMTP_USER:-user@example.com}
  SMTP_PASSWORD: ${SMTP_PASSWORD:-your-smtp-password}
  FROM_EMAIL: ${FROM_EMAIL:-noreply@example.com}

x-common-jwt: &common-jwt
  JWT_SECRET_KEY: ${JWT_SECRET_KEY}
  JWT_ALGORITHM: ${JWT_ALGORITHM}
  JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES}

x-common-environment: &common-environment
  ENVIRONMENT: ${ENVIRONMENT}
  BACKEND_ENV: ${BACKEND_ENV}
  FRONTEND_ENV: ${FRONTEND_ENV}
  WORKER_ENV: ${WORKER_ENV}
  LOG_LEVEL: ${LOG_LEVEL}

x-rhesis-config: &rhesis-config
  RHESIS_BASE_URL: ${RHESIS_BASE_URL}
  RHESIS_API_KEY: ${RHESIS_API_KEY}
  FRONTEND_URL: ${FRONTEND_URL}
  BACKEND_URL: ${BACKEND_URL}
  DEFAULT_GENERATION_MODEL: ${DEFAULT_GENERATION_MODEL}
  DEFAULT_MODEL_NAME: ${DEFAULT_MODEL_NAME}

x-telemetry-config: &telemetry-config
  OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT}
  OTEL_SERVICE_NAME: ${OTEL_SERVICE_NAME}
  DEPLOYMENT_TYPE: ${DEPLOYMENT_TYPE}
  TELEMETRY_ENABLED: ${TELEMETRY_ENABLED}

x-gemini-google: &gemini-google
  GEMINI_API_KEY: ${GEMINI_API_KEY:-}
  GEMINI_MODEL_NAME: ${GEMINI_MODEL_NAME:-}
  GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}

x-nextjs-frontend: &nextjs-frontend
  NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
  NEXTAUTH_URL: ${NEXTAUTH_URL}
  NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
  NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
  NEXT_PUBLIC_AUTH0_DOMAIN: ${NEXT_PUBLIC_AUTH0_DOMAIN}
  NEXT_PUBLIC_AUTH0_CLIENT_ID: ${NEXT_PUBLIC_AUTH0_CLIENT_ID}
  NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED}
  NEXT_PUBLIC_LOCAL_AUTH_ENABLED: ${NEXT_PUBLIC_LOCAL_AUTH_ENABLED}

x-google-client: &google-client
  GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
  GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}

services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: rhesis-postgres
    environment:
      POSTGRES_DB: ${SQLALCHEMY_DB_NAME}
      POSTGRES_USER: ${SQLALCHEMY_DB_USER}
      POSTGRES_PASSWORD: ${SQLALCHEMY_DB_PASS}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./apps/backend/src/rhesis/backend/alembic/create_user.sql:/docker-entrypoint-initdb.d/01-create-user.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${SQLALCHEMY_DB_USER} -d ${SQLALCHEMY_DB_NAME}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rhesis-network

  # Redis for Celery
  redis:
    image: redis:7-alpine
    container_name: rhesis-redis
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - rhesis-network

  # Backend API with local development defaults
  backend:
    build:
      context: .
      dockerfile: apps/backend/Dockerfile
    container_name: rhesis-backend
    environment:
      <<: [*common-database, *common-redis, *common-auth0, *common-smtp, *common-jwt, *common-environment, *rhesis-config, *gemini-google, *telemetry-config]
      LOG_LEVEL: ${LOG_LEVEL}
      LOCAL_AUTH_ENABLED: ${LOCAL_AUTH_ENABLED}
    ports:
      - "8080:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./apps/backend/src:/app/src
      - ./sdk:/app/sdk
    networks:
      - rhesis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Celery Worker
  worker:
    build:
      context: .
      dockerfile: apps/worker/Dockerfile
    container_name: rhesis-worker
    environment:
      <<: [*common-database, *common-redis, *common-auth0, *common-smtp, *common-jwt, *common-environment, *rhesis-config]
      LOG_LEVEL: ${CELERY_WORKER_LOGLEVEL}
      CELERY_WORKER_CONCURRENCY: ${CELERY_WORKER_CONCURRENCY}
      CELERY_WORKER_PREFETCH_MULTIPLIER: ${CELERY_WORKER_PREFETCH_MULTIPLIER}
      CELERY_WORKER_MAX_TASKS_PER_CHILD: ${CELERY_WORKER_MAX_TASKS_PER_CHILD}
      CELERY_WORKER_LOGLEVEL: ${CELERY_WORKER_LOGLEVEL}
      USE_TCP_DATABASE: ${USE_TCP_DATABASE}
      ENABLE_FLOWER: ${ENABLE_FLOWER}
    ports:
      - "8081:8081"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./sdk:/app/sdk
    networks:
      - rhesis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health/basic"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Frontend with local development configuration
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile
      args:
        FRONTEND_ENV: ${FRONTEND_ENV}
        NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
        NEXT_PUBLIC_AUTH0_DOMAIN: ${NEXT_PUBLIC_AUTH0_DOMAIN}
        NEXT_PUBLIC_AUTH0_CLIENT_ID: ${NEXT_PUBLIC_AUTH0_CLIENT_ID}
        NEXT_PUBLIC_LOCAL_AUTH_ENABLED: ${NEXT_PUBLIC_LOCAL_AUTH_ENABLED}
    container_name: rhesis-frontend
    environment:
      <<: [*common-auth0, *nextjs-frontend, *google-client, *common-environment, *rhesis-config]
      PORT: ${FRONTEND_PORT}
      NEXT_PUBLIC_OTEL_ENDPOINT: ${NEXT_PUBLIC_OTEL_ENDPOINT:-}
      NEXT_PUBLIC_DEPLOYMENT_TYPE: ${NEXT_PUBLIC_DEPLOYMENT_TYPE}
    ports:
      - "3000:3000"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - rhesis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/auth/session"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Documentation
  docs:
    build:
      context: ./docs
      dockerfile: src/Dockerfile
    container_name: rhesis-docs
    environment:
      <<: [*common-environment]
      PORT: 3001
    ports:
      - "3001:3001"
    networks:
      - rhesis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  rhesis-network:
    driver: bridge
