name: Publish to PyPI

# Trigger logic:
# - sdk-v* tags: publish SDK only
# - v* tags (platform): publish SDK first, then rhesis umbrella package
# - workflow_dispatch: manual control over what to publish

on:
  push:
    tags:
      - 'v*'      # Platform version tags (e.g., v0.6.4)
      - 'sdk-v*'  # SDK-only version tags (e.g., sdk-v0.6.4)
  workflow_dispatch:
    inputs:
      publish_sdk:
        description: 'Publish rhesis-sdk'
        type: boolean
        default: true
      publish_rhesis:
        description: 'Publish rhesis umbrella package'
        type: boolean
        default: true
  workflow_call:

jobs:
  publish-sdk:
    # Publish SDK on: sdk-v* tags, v* tags, workflow_dispatch (if selected), workflow_call
    if: |
      github.event_name == 'push' ||
      github.event_name == 'workflow_call' ||
      (github.event_name == 'workflow_dispatch' && inputs.publish_sdk)
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/rhesis-sdk
    permissions:
      id-token: write  # Required for trusted publishing
    
    steps:
    - name: Setup Python build environment
      uses: ./.github/actions/setup-python-build
    
    - name: Build SDK
      working-directory: ./sdk
      run: python -m build
    
    - name: Publish rhesis-sdk to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: ./sdk/dist/

  publish-rhesis:
    # Publish rhesis umbrella on: v* tags only (NOT sdk-v*), workflow_dispatch (if selected), workflow_call
    # Skip for sdk-v* tags since those are SDK-only releases
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      github.event_name == 'workflow_call' ||
      (github.event_name == 'workflow_dispatch' && inputs.publish_rhesis)
    needs: publish-sdk
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/rhesis
    permissions:
      id-token: write  # Required for trusted publishing
    
    steps:
    - name: Setup Python build environment
      uses: ./.github/actions/setup-python-build
    
    - name: Build rhesis
      working-directory: ./packages/rhesis
      run: python -m build
    
    - name: Publish rhesis to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        packages-dir: ./packages/rhesis/dist/
